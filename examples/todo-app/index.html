<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Browseress Todo App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f0f0f0;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    .status.connected {
      background: #d4edda;
      color: #155724;
    }
    .status.disconnected {
      background: #f8d7da;
      color: #721c24;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .endpoints {
      background: #e9ecef;
      padding: 15px;
      border-radius: 4px;
      margin-top: 15px;
    }
    .endpoints h3 {
      margin-top: 0;
    }
    code {
      background: #f8f9fa;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>üóíÔ∏è Browseress Todo App</h1>
  <p>A todo list API running entirely in your browser!</p>

  <div class="container">
    <h2>Server Status</h2>
    <div id="status" class="status disconnected">Disconnected</div>
    <button id="startBtn" onclick="startServer()">Start Todo Server</button>
    <button id="stopBtn" onclick="stopServer()" disabled>Stop Server</button>
    <button onclick="clearLog()">Clear Log</button>
  </div>

  <div class="container">
    <h2>Server Log</h2>
    <div id="log" class="log"></div>
  </div>

  <div class="container" id="apiDocs" style="display: none;">
    <h2>API Documentation</h2>
    <div class="endpoints">
      <h3>Available Endpoints:</h3>
      
      <h4>GET /todos</h4>
      <p>Get all todos</p>
      <pre>curl http://localhost:8080/todos</pre>
      
      <h4>POST /todos</h4>
      <p>Create a new todo</p>
      <pre>curl -X POST http://localhost:8080/todos \
  -H "Content-Type: application/json" \
  -d '{"title":"Buy groceries","completed":false}'</pre>
      
      <h4>GET /todos/:id</h4>
      <p>Get a specific todo</p>
      <pre>curl http://localhost:8080/todos/1</pre>
      
      <h4>PUT /todos/:id</h4>
      <p>Update a todo</p>
      <pre>curl -X PUT http://localhost:8080/todos/1 \
  -H "Content-Type: application/json" \
  -d '{"title":"Buy groceries","completed":true}'</pre>
      
      <h4>DELETE /todos/:id</h4>
      <p>Delete a todo</p>
      <pre>curl -X DELETE http://localhost:8080/todos/1</pre>
      
      <h4>DELETE /todos</h4>
      <p>Delete all todos (useful for testing)</p>
      <pre>curl -X DELETE http://localhost:8080/todos</pre>
    </div>
  </div>

  <script src="../../dist/browseress.bundle.js"></script>
  <script>
    let app;
    let transport;
    let todos = [];
    let nextId = 1;
    
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      const entry = `[${time}] ${message}\n`;
      logDiv.textContent += entry;
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    function updateStatus(text, connected) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = text;
      statusDiv.className = `status ${connected ? 'connected' : 'disconnected'}`;
      
      document.getElementById('startBtn').disabled = connected;
      document.getElementById('stopBtn').disabled = !connected;
      document.getElementById('apiDocs').style.display = connected ? 'block' : 'none';
    }
    
    function clearLog() {
      document.getElementById('log').textContent = '';
    }
    
    async function startServer() {
      try {
        log('Starting Express todo server...');
        
        // Get Express and WebSocketTransport from bundle
        const express = window.browseress.express;
        const WebSocketTransport = window.browseress.WebSocketTransport;
        
        // Create Express app
        app = express();
        
        // Middleware
        app.use((req, res, next) => {
          // Parse query string
          const urlParts = req.url.split('?');
          req.path = urlParts[0];
          req.query = {};
          
          if (urlParts[1]) {
            const queryString = urlParts[1];
            const pairs = queryString.split('&');
            pairs.forEach(pair => {
              const [key, value] = pair.split('=');
              if (key) {
                req.query[decodeURIComponent(key)] = value ? decodeURIComponent(value) : '';
              }
            });
          }
          
          // Parse JSON body
          if (req.headers['content-type'] === 'application/json') {
            let body = '';
            req.on('data', chunk => body += chunk);
            req.on('end', () => {
              try {
                req.body = JSON.parse(body);
              } catch (e) {
                req.body = {};
              }
              next();
            });
          } else {
            next();
          }
        });
        
        // Logging middleware
        app.use((req, res, next) => {
          const start = Date.now();
          const originalEnd = res.end;
          res.end = function() {
            const duration = Date.now() - start;
            log(`${req.method} ${req.url} - ${res.statusCode} (${duration}ms)`);
            originalEnd.apply(res, arguments);
          };
          next();
        });
        
        // Routes
        app.get('/', (req, res) => {
          res.json({
            name: 'Browseress Todo API',
            version: '1.0.0',
            endpoints: [
              'GET /todos',
              'POST /todos',
              'GET /todos/:id',
              'PUT /todos/:id',
              'DELETE /todos/:id'
            ]
          });
        });
        
        // GET all todos with filtering and pagination
        app.get('/todos', (req, res) => {
          let result = [...todos];
          
          // Filter by completed status
          if (req.query.completed !== undefined) {
            const completed = req.query.completed === 'true';
            result = result.filter(todo => todo.completed === completed);
          }
          
          // Search by title
          if (req.query.q) {
            const query = req.query.q.toLowerCase();
            result = result.filter(todo => 
              todo.title.toLowerCase().includes(query)
            );
          }
          
          // Pagination
          const page = parseInt(req.query.page) || 1;
          const limit = parseInt(req.query.limit) || 10;
          const startIndex = (page - 1) * limit;
          const endIndex = page * limit;
          
          const paginatedResults = result.slice(startIndex, endIndex);
          
          res.set({
            'X-Total-Count': result.length.toString(),
            'X-Page': page.toString(),
            'X-Limit': limit.toString()
          });
          
          res.json(paginatedResults);
        });
        
        // POST new todo with validation
        app.post('/todos', (req, res) => {
          // Validation
          if (!req.body.title || req.body.title.trim().length === 0) {
            return res.status(400).json({ 
              error: 'Validation failed',
              details: { title: 'Title is required' }
            });
          }
          
          const todo = {
            id: nextId++,
            title: req.body.title.trim(),
            completed: req.body.completed === true,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };
          
          todos.push(todo);
          
          res.status(201)
            .location(`/todos/${todo.id}`)
            .json(todo);
        });
        
        // GET single todo
        app.get('/todos/:id', (req, res) => {
          const id = parseInt(req.params.id);
          
          if (isNaN(id)) {
            return res.status(400).json({ error: 'Invalid ID format' });
          }
          
          const todo = todos.find(t => t.id === id);
          
          if (todo) {
            res.json(todo);
          } else {
            res.status(404).json({ error: 'Todo not found' });
          }
        });
        
        // PUT full update todo
        app.put('/todos/:id', (req, res) => {
          const id = parseInt(req.params.id);
          
          if (isNaN(id)) {
            return res.status(400).json({ error: 'Invalid ID format' });
          }
          
          // Validation
          if (!req.body.title || req.body.title.trim().length === 0) {
            return res.status(400).json({ 
              error: 'Validation failed',
              details: { title: 'Title is required' }
            });
          }
          
          const index = todos.findIndex(t => t.id === id);
          
          if (index !== -1) {
            todos[index] = {
              id: id,
              title: req.body.title.trim(),
              completed: req.body.completed === true,
              createdAt: todos[index].createdAt,
              updatedAt: new Date().toISOString()
            };
            res.json(todos[index]);
          } else {
            res.status(404).json({ error: 'Todo not found' });
          }
        });
        
        // PATCH partial update todo
        app.patch('/todos/:id', (req, res) => {
          const id = parseInt(req.params.id);
          
          if (isNaN(id)) {
            return res.status(400).json({ error: 'Invalid ID format' });
          }
          
          const index = todos.findIndex(t => t.id === id);
          
          if (index !== -1) {
            // Only update provided fields
            if (req.body.title !== undefined) {
              if (req.body.title.trim().length === 0) {
                return res.status(400).json({ 
                  error: 'Validation failed',
                  details: { title: 'Title cannot be empty' }
                });
              }
              todos[index].title = req.body.title.trim();
            }
            
            if (req.body.completed !== undefined) {
              todos[index].completed = req.body.completed === true;
            }
            
            todos[index].updatedAt = new Date().toISOString();
            res.json(todos[index]);
          } else {
            res.status(404).json({ error: 'Todo not found' });
          }
        });
        
        // DELETE todo
        app.delete('/todos/:id', (req, res) => {
          const id = parseInt(req.params.id);
          
          if (isNaN(id)) {
            return res.status(400).json({ error: 'Invalid ID format' });
          }
          
          const index = todos.findIndex(t => t.id === id);
          
          if (index !== -1) {
            const deleted = todos.splice(index, 1)[0];
            res.status(204).send(); // No content on successful delete
          } else {
            res.status(404).json({ error: 'Todo not found' });
          }
        });
        
        // DELETE all todos (for testing)
        app.delete('/todos', (req, res) => {
          const count = todos.length;
          todos = [];
          nextId = 1;
          res.json({ deleted: count });
        });
        
        // OPTIONS for CORS preflight
        app.options('/todos', (req, res) => {
          res.set({
            'Allow': 'GET, POST, OPTIONS',
            'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
            'Access-Control-Allow-Headers': 'Content-Type'
          });
          res.status(204).send();
        });
        
        app.options('/todos/:id', (req, res) => {
          res.set({
            'Allow': 'GET, PUT, PATCH, DELETE, OPTIONS',
            'Access-Control-Allow-Methods': 'GET, PUT, PATCH, DELETE, OPTIONS',
            'Access-Control-Allow-Headers': 'Content-Type'
          });
          res.status(204).send();
        });
        
        // 404 handler
        app.use((req, res) => {
          res.status(404).json({ error: 'Not found' });
        });
        
        // Create transport
        transport = new WebSocketTransport('ws://localhost:3001');
        
        transport.on('connect', () => {
          log('Connected to relay server!');
          updateStatus('Connected - Todo API is live!', true);
          log('Server ready at http://localhost:8080');
          
          // Add some sample todos
          todos = [
            { id: nextId++, title: 'Learn Browseress', completed: true, createdAt: new Date().toISOString() },
            { id: nextId++, title: 'Build something awesome', completed: false, createdAt: new Date().toISOString() }
          ];
          log('Added 2 sample todos');
        });
        
        transport.on('disconnect', () => {
          log('Disconnected from relay server');
          updateStatus('Disconnected', false);
        });
        
        transport.on('error', (err) => {
          log(`Error: ${err.message}`);
        });
        
        // Start listening
        app.listen(transport, (err) => {
          if (err) {
            log(`Failed to start: ${err.message}`);
            updateStatus('Failed to start', false);
          }
        });
        
      } catch (err) {
        log(`Error: ${err.message}`);
        console.error(err);
      }
    }
    
    function stopServer() {
      if (transport) {
        log('Stopping server...');
        transport.close();
        transport = null;
        app = null;
        todos = [];
        nextId = 1;
        updateStatus('Disconnected', false);
      }
    }
    
    // Auto-start on load
    window.addEventListener('load', () => {
      log('Browseress Todo App loaded');
      log('Click "Start Todo Server" to begin');
    });
  </script>
</body>
</html>