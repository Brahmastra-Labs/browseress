<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Browseress Phase 1 Test App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f0f0f0;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    .status.connected {
      background: #d4edda;
      color: #155724;
    }
    .status.disconnected {
      background: #f8d7da;
      color: #721c24;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 10px;
      height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .endpoints {
      background: #e9ecef;
      padding: 15px;
      border-radius: 4px;
      margin-top: 15px;
    }
    code {
      background: #f8f9fa;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h1>ðŸ§ª Browseress Phase 1 Test App</h1>
  <p>Testing request properties and response header methods</p>

  <div class="container">
    <h2>Server Status</h2>
    <div id="status" class="status disconnected">Disconnected</div>
    <button id="startBtn" onclick="startServer()">Start Test Server</button>
    <button id="stopBtn" onclick="stopServer()" disabled>Stop Server</button>
    <button onclick="clearLog()">Clear Log</button>
  </div>

  <div class="container">
    <h2>Server Log</h2>
    <div id="log" class="log"></div>
  </div>

  <div class="container" id="testEndpoints" style="display: none;">
    <h2>Phase 1 Test Endpoints</h2>
    <div class="endpoints">
      <h3>Request Properties:</h3>
      <p><code>GET /req-test</code> - Returns request properties (ip, protocol, secure, cookies)</p>
      
      <h3>Response Headers:</h3>
      <p><code>GET /header-test</code> - Tests cookie, append, and redirect</p>
      <p><code>GET /append-test</code> - Tests header appending</p>
      <p><code>GET /cookie-test</code> - Tests multiple cookies</p>
      <p><code>GET /clear-cookie-test</code> - Tests cookie clearing</p>
      <p><code>GET /redirect-301</code> - Tests permanent redirect</p>
    </div>
  </div>

  <script src="../../dist/browseress.bundle.js"></script>
  <script>
    let app;
    let transport;
    
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      const entry = `[${time}] ${message}\n`;
      logDiv.textContent += entry;
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    function updateStatus(text, connected) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = text;
      statusDiv.className = `status ${connected ? 'connected' : 'disconnected'}`;
      
      document.getElementById('startBtn').disabled = connected;
      document.getElementById('stopBtn').disabled = !connected;
      document.getElementById('testEndpoints').style.display = connected ? 'block' : 'none';
    }
    
    function clearLog() {
      document.getElementById('log').textContent = '';
    }
    
    async function startServer() {
      try {
        log('Starting Phase 1 test server...');
        
        // Get Express and WebSocketTransport from bundle
        const express = window.browseress.express;
        const WebSocketTransport = window.browseress.WebSocketTransport;
        
        // Create Express app
        app = express();
        
        // Middleware to parse JSON
        app.use((req, res, next) => {
          if (req.headers['content-type'] === 'application/json') {
            let body = '';
            req.on('data', chunk => body += chunk);
            req.on('end', () => {
              try {
                req.body = JSON.parse(body);
              } catch (e) {
                req.body = {};
              }
              next();
            });
          } else {
            next();
          }
        });
        
        // Logging middleware
        app.use((req, res, next) => {
          const start = Date.now();
          const originalEnd = res.end;
          res.end = function() {
            const duration = Date.now() - start;
            log(`${req.method} ${req.url} - ${res.statusCode} (${duration}ms)`);
            originalEnd.apply(res, arguments);
          };
          next();
        });
        
        // Phase 1 Test Routes
        
        // Test Case 1: Request Properties
        app.get('/req-test', (req, res) => {
          res.json({
            ip: req.ip,
            protocol: req.protocol,
            secure: req.secure,
            cookies: req.cookies,
            ips: req.ips,
            headers: req.headers
          });
        });
        
        // Test Case 2: Response Headers
        app.get('/header-test', (req, res) => {
          res.cookie('test', 'value');
          res.append('X-Custom', 'hello');
          res.redirect('/target');
        });
        
        // Additional test routes
        app.get('/append-test', (req, res) => {
          res.append('Cache-Control', 'no-cache');
          res.append('Cache-Control', 'no-store');
          res.send('Headers appended');
        });
        
        app.get('/cookie-test', (req, res) => {
          res.cookie('test1', 'value1', { httpOnly: true });
          res.cookie('test2', 'value2', { secure: true, sameSite: 'Strict' });
          res.send('Cookies set');
        });
        
        app.get('/clear-cookie-test', (req, res) => {
          res.clearCookie('oldCookie');
          res.send('Cookie cleared');
        });
        
        app.get('/redirect-301', (req, res) => {
          res.redirect(301, '/permanent');
        });
        
        // Default route
        app.get('/', (req, res) => {
          res.json({
            name: 'Browseress Phase 1 Test Server',
            tests: [
              'GET /req-test',
              'GET /header-test',
              'GET /append-test',
              'GET /cookie-test',
              'GET /clear-cookie-test',
              'GET /redirect-301'
            ]
          });
        });
        
        // 404 handler
        app.use((req, res) => {
          res.status(404).json({ error: 'Not found' });
        });
        
        // Create transport
        transport = new WebSocketTransport('ws://localhost:3001');
        
        transport.on('connect', () => {
          log('Connected to relay server!');
          updateStatus('Connected - Phase 1 Test Server is live!', true);
          log('Server ready at http://localhost:8080');
        });
        
        transport.on('disconnect', () => {
          log('Disconnected from relay server');
          updateStatus('Disconnected', false);
        });
        
        transport.on('error', (err) => {
          log(`Error: ${err.message}`);
        });
        
        // Start listening
        app.listen(transport, (err) => {
          if (err) {
            log(`Failed to start: ${err.message}`);
            updateStatus('Failed to start', false);
          }
        });
        
      } catch (err) {
        log(`Error: ${err.message}`);
        console.error(err);
      }
    }
    
    function stopServer() {
      if (transport) {
        log('Stopping server...');
        transport.close();
        transport = null;
        app = null;
        updateStatus('Disconnected', false);
      }
    }
    
    // Auto-start on load
    window.addEventListener('load', () => {
      log('Browseress Phase 1 Test App loaded');
      log('Click "Start Test Server" to begin');
      log('Remember to start the relay server first!');
    });
  </script>
</body>
</html>